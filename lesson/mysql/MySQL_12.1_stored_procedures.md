# MySQL — Урок 12.1. Хранимые процедуры (Stored Procedures)

## 1) Что такое хранимая процедура
**Хранимая процедура** (*stored procedure*) — это блок SQL-кода, который сохраняется в базе данных и может вызываться многократно.  
Процедуры выполняются на стороне сервера и помогают автоматизировать повторяющиеся операции, выполнять вычисления и управлять процессами на сервере.

---

## 2) Почему это полезно
Основные особенности/плюсы хранимых процедур:
- **Производительность**: запросы/логика хранятся на сервере и могут выполняться эффективнее благодаря подготовке/компилированию.
- **Сложная бизнес-логика**: удобно выносить “сложные сценарии” в серверную часть.
- **Безопасность**: можно дать пользователям право вызывать процедуру, не давая прямых прав на таблицы.
- **Переиспользование**: один раз написали — много раз вызываем.

---

## 3) Компилирование SQL-запросов (идея)
Компилирование — это этап обработки запроса сервером БД перед выполнением: запрос “разбирается”, планируется и оптимизируется для более эффективного выполнения.

---

## 4) Создание процедуры: базовый синтаксис
В MySQL обычно меняют разделитель команд, потому что внутри `BEGIN ... END` используются `;`.

```sql
DELIMITER $$

CREATE PROCEDURE procedure_name ([parameters])
BEGIN
  -- тело процедуры
END $$

DELIMITER ;
```

### Параметры процедуры
Процедура может принимать параметры:
- `IN` — входной параметр (передаём значение внутрь)
- `OUT` — выходной параметр (процедура “записывает” значение наружу)
- `INOUT` — одновременно вход и выход

---

## 5) Пример: процедура добавления сотрудника (INSERT)
### 5.1. Процедура `add_employee`
```sql
DELIMITER $$

CREATE PROCEDURE add_employee(
  IN emp_name VARCHAR(100),
  IN emp_age  INT
)
BEGIN
  INSERT INTO employees (name, age)
  VALUES (emp_name, emp_age);
END $$

DELIMITER ;
```

### 5.2. Подготовка (таблица для практики)
Перед вызовом процедуры нужно создать таблицу (и заполнить её любыми данными для тестов):
```sql
CREATE TABLE employees (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100),
  age INT,
  salary INT,
  department_id INT
);
```

---

## 6) Вызов процедуры
Синтаксис:
```sql
CALL procedure_name(arg1, arg2, ...);
```

Пример:
```sql
CALL add_employee('John Doe', 30);
```

---

## 7) Практика: “Зарплата выше средней” (IN + OUT, IF, переменные)
**Задание:** создать процедуру, которая принимает `employee_id` (IN) и возвращает `1` или `0` (OUT):  
- `1` если зарплата сотрудника выше средней зарплаты по всем департаментам  
- иначе `0`

### Решение (как в материалах)
```sql
DELIMITER //

CREATE PROCEDURE higher_than_avg(
  IN  employee_in DECIMAL(6,0),
  OUT is_higher   INTEGER
)
BEGIN
  DECLARE avg_salary      DECIMAL(8,2);
  DECLARE employee_salary DECIMAL(8,2);

  SET avg_salary = (SELECT AVG(salary) FROM employees);
  SET employee_salary = (SELECT salary
                         FROM employees
                         WHERE employee_id = employee_in);

  IF employee_salary > avg_salary THEN
    SET is_higher = 1;
  ELSE
    SET is_higher = 0;
  END IF;
END //

DELIMITER ;
```

### Вызов с OUT-переменной
```sql
CALL higher_than_avg(1, @is_higher);
SELECT @is_higher;
```

---

## 8) Быстрая памятка
- Процедура создаётся через `CREATE PROCEDURE`.
- Для многострочного тела почти всегда нужен `DELIMITER`.
- Для “возврата результата” используем `OUT` или `INOUT` (процедура не возвращает значение как функция).
- Внутри можно использовать переменные (`DECLARE`), присваивание (`SET`) и условия (`IF ... THEN ... END IF`).
