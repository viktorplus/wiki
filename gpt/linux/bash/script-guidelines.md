# Bash-скрипты — базовые правила

Коротко: пишите bash-код чисто, безопасно и предсказуемо — обязательно прописывайте `#!/bin/bash`, проверяйте ошибки и документируйте интерфейс скрипта.
#bash, #shell, #scripts
---

## Структура скрипта

1. **Shebang:** `#!/usr/bin/env bash` — переносимый путь к интерпретатору.
2. **`set`-сы:**
   ```bash
   set -euo pipefail
   IFS=$'\n\t'
   ```
   Это включает выход при ошибке, запрет использования необъявленных переменных и честное поведение пайпов.
3. **Описание:** короткий комментарий вверху, для чего скрипт (например, `# Обновляет бэкап и выгружает логи`).

## Входные параметры и переменные

- Обрабатывайте аргументы: используйте `usage()` и проверку `if [[ $# -lt 1 ]]; then usage; exit 1; fi`.
- Задавайте переменные через `local` внутри функций и `readonly` для констант.
- Избегайте глобального `PATH`-перезаписывания; используйте `command -v` для проверки зависимостей.
- Для путей пользуйтесь `${BASH_SOURCE[0]}` / `dirname` (если нужно работать из каталога скрипта).

## Функции и логика

- Разбивайте на функции: `main() { ...; }` и вызывайте `main "${@}"` в конце.
- Всегда возвращайте код завершения или используйте `return` внутри функций.
- Логируйте действия: `log() { printf '%s
' "$*"; }` или выводите в stderr `>&2`.
- Проверяйте команды: `if ! command; then fail "..."; fi`.

## Обработка ошибок и cleanup

- Перед `exit` вызывайте `trap 'cleanup' EXIT` для очистки временных файлов.
- Применяйте `mktemp` для временных файлов/каталогов и удаляйте их в trap.
- Используйте `[[ ]]` вместо `[ ]` для избегания проблем с пробелами.
- При работе с пользовательским вводом экранируйте значения `printf '%q'` и избегайте `eval`.

## Форматирование и документация

- Ставьте отступ 2 пробела (или таб) внутри функций/условий.
- Комментируйте нестандартные участки `# why we do this`.
- Соблюдайте `shellcheck`-совместимость (`shellcheck script.sh`).
- В описании CLI указывайте: `usage() { cat <<EOF ... }`.

## Безопасность

- Не храните секреты в открытом виде; читайте из файлов с `chmod 600`.
- Не запускайте команды с подстановками пользователем без `printf '%q'` или безопасной обработки.
- Избегайте слабых ссылок вроде `curl ... | sh`; если нужно, проверяйте подпись.

## Тестирование и запуск

- Запускайте `bash -n script.sh` перед первым исполнением.
- Для дебага используйте `bash -x script.sh` (или `set -x` на небольшой блок).
- Храните пример запуска в README или комментариях: `# ./deploy.sh --dry-run`.

## Примеры файлов

```
#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

usage() {
  cat <<EOF >&2
Usage: ${0##*/} SOURCE DEST
EOF
}

main() {
  : # основной код
}

main "${@-}"
```

## Ссылки и инструменты

- `man bash`, `help set`
- `shellcheck` — статический анализатор
- `shfmt` — автоформатирование

---

Вернуться к [главной странице](../README.md).
