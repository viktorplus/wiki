# awk — шпаргалка

Коротко: `awk` — мощный текстовый процессор для разбора полей и
строк (часто используется для CSV/TSV и логов). `awk` читает вход
построчно, разбивает строки на поля и выполняет действия по шаблонам.
#awk, #linux, #text
---

## Синтаксис

```
awk [OPTIONS] 'pattern { action }' file...
awk -F ':' '{ print $1 }' /etc/passwd
awk -f script.awk file
```

Если `pattern` опущен — действие выполняется для каждой строки.

## Важные переменные

- `$0` — вся строка
- `$1, $2, ...` — поля (по умолчанию разделитель — пробел/таб)
- `NF` — число полей в текущей строке
- `NR` — номер текущей строки (в рамках всего ввода)
- `FNR` — номер строки в текущем файле
- `FS` — входной разделитель полей (Field Separator)
- `OFS` — выходной разделитель полей
- `ORS` — выходной разделитель строк
- `RS` — входной разделитель записей (обычно \n)

## Полезные опции командной строки

- `-F` — задать `FS`, например `-F,` для CSV
- `-v name=value` — задать переменную перед выполнением
- `-f scriptfile` — выполнить awk-скрипт из файла
- `--re-interval` — включить повторения `{m,n}` в некоторых реализациях (обычно не нужно для gawk)

## Блоки: BEGIN / END

- `BEGIN { ... }` — выполняется до обработки ввода (подходит для инициализации)
- `END { ... }` — выполняется после обработки всего ввода (подходит для сумм/отчётов)

Пример:

```
awk 'BEGIN { sum=0 } { sum += $3 } END { print sum }' file
```

## Частые операции

- Вывести первое поле:

```
awk '{ print $1 }' file
```

- Вывести N-ю колонку (tab-delimited):

```
awk -F"\t" '{ print $4 }' file.tsv
```

- Суммировать колонку:

```
awk '{ sum += $2 } END { print sum }' file
```

- Посчитать строки, соответствующие шаблону:

```
awk '/error/ { c++ } END { print c+0 }' logfile
```

- Выбрать строки с определённым числом полей (например, 3):

```
awk 'NF==3' file
```

- Поменять разделитель и вывести объединённую строку:

```
awk -F',' 'BEGIN{OFS=";"} { $1=$1; print }' file.csv
```
(трюк `$1=$1` заставляет awk пересобрать `$0` с новым `OFS`)

- Использовать условие и действие:

```
awk '$5 > 100 { print $1, $5 }' data.txt
```

## Форматированный вывод

- `printf` — как в C, полезно для аккуратных таблиц:

```
awk '{ printf "% -20s %6.2f\n", $1, $2 }' file
```

## Работа с регулярными выражениями и функциями

- Поиск по regexp: `/pattern/ { action }`
- `match(s, r)` — возвращает позицию и заполняет массив `RSTART`, `RLENGTH`
- `sub(r, repl, s)` — заменить первое совпадение в строке
- `gsub(r, repl, s)` — заменить все совпадения в строке
- `split(s, arr, fs)` — разделяет строку `s` в массив `arr` по `fs`
- `substr(s, i, n)` — подстрока
- `length(s)` — длина строки (или `length()` для `$0`)
- `index(s, t)` — позиция подстроки
- `tolower(s)`, `toupper(s)` — регистры

Пример использования `gsub`:

```
awk '{ gsub(/\r/, ""); print }' file      # удалить CR из DOS-файла
```

## gawk-специфичные функции (полезно, если установлен gawk)

- `gensub(regexp, replacement, how [, target])` — более гибкая замена
- `strftime(format, timestamp)` — форматирование времени
- `sprintf(...)` — возвращает отформатированную строку

## Примеры практических задач

- Вывести имена пользователей и UID из `/etc/passwd`:

```
awk -F: '{ print $1, $3 }' /etc/passwd
```

- Найти строки с повторяющимися полями или пустыми полями:

```
awk -F',' 'NF != expected { print NR, $0 }' file.csv
```

- Подсчитать уникальные значения в колонке (простая версия):

```
awk '{ cnt[$1]++ } END { for (i in cnt) print i, cnt[i] }' file
```

- Сумма значений для каждой группы (агрегация):

```
awk '{ sum[$1] += $2 } END { for (k in sum) print k, sum[k] }' data.txt
```

- Извлечь N-ю колонку из CSV, учтя кавычки — лучше использовать специализированные парсеры, но простая версия:

```
awk -F',' '{ print $3 }' file.csv
```

## Использование с пайпами

```
ps aux | awk '$3 > 0.5 { print $1, $3 }'
journalctl -u nginx | awk '/error/ { print $0 }'
```

Совет: для сложного CSV используйте `csvkit` или Python; `awk` подходит для простых таблиц.

## Производительность и замены

- `awk` хорош для потоковой обработки; для больших проектов рассмотрите `gawk` или специализированные инструменты.
- Для быстрого рекурсивного поиска по проекту используйте `rg`/`ag` в комбинации с `awk`.

## Справка

- `man awk` и `info awk`
- GNU Awk manual: https://www.gnu.org/software/gawk/manual/

---

Если хотите, могу:

- добавить готовые регулярки (email, IP, URL, дата);
- сделать примеры для CSV с кавычками;
- подготовить краткую версию на английском.


Вернуться к [главной странице](./README.md).
